<section class="no-padding-top no-padding-bottom">
  <div class="container-fluid">

    <!-- Welcome Msg -->

    <div class="row">
      <div class="col-12">
        <div class="block">
          <a href="/network" style="width:100%">
            <img src="assets/img/banner_long.jpg" alt="" style="width:100%">
          </a>
        </div>
      </div>
    </div>

    <div class="row" id="canhbao" style="display:<%- canhbao.display %>">
      <div class="col-12">
        <div id="canhbao-inner" class="alert fade alert-simple alert-dismissible text-left font__family-montserrat font__size-16 font__weight-light brk-library-rendered rendered show" role="alert" data-brk-library="component__alert">
          <i class="start-icon fa fa-exclamation-triangle faa-flash animated"></i>
          <strong class="font__weight-semibold">Thông điệp từ Admin: </strong> <span id="canhbaoMsg"><%- canhbao.msg %></span>.
        </div>
      </div>
    </div>

  </div>
  <div class="container-fluid">
    <div class="row">


      <% if(user.phongthan) { %>
      <div class="col-xl-6 col-12">
        <!--PHONG THAN begin-->
        <div class="block" style="">
          <div class="row title">
            <div class="col-5 text-left">
              Bảng phong thần
            </div>
            <div class="col-4 text-right">
              <div class="tooltips">Phân bổ vốn <i class="fa fa-question-circle" aria-hidden="true"></i>
                <%- include('diversifyTooltips.ejs') %>
              </div>
            </div>
            <div class="col-3 text-right">
              <div class="tooltips">
                Chú thích
                <i class="fa fa-question-circle" aria-hidden="true"></i>
                <ul class="tooltiptext" style="font-size:1em;">
                  <li>form 0: điểm mua rủi ro</li>
                  <li>form 1: uptrend dài</li>
                  <li>form 2: uptrend dài, downtrend ngắn</li>
                  <li>form 3: downtrend dài, uptrend ngắn</li>
                </ul>
              </div>
            </div>
          </div>

          <div id='bangPhongThan' class="block-content" style="height:350px;overflow: auto;">

          </div>
        </div>
        <!--PHONG THAN end-->
      </div>
      <% } %>

      <% if(user.ddk) { %>
      <div class="col-lg-6">
          <!-- DDK Begin-->
          <div class="block" style="">
            <!--div class="title">Các mã đủ điều kiện <span id="ddk-noti" style="float: right;font-size: 25px;" onclick="openNoti()">Thông báo<i class="start-icon fa fa-info-circle faa-tada animated"></i></span></div-->
            <div class="row title">
              <div class="col-5 text-left">
                Các mã đủ điều kiện
              </div>
              <div class="col-4 text-right">
                <div class="tooltips ddk-noti-active" id="chotLoiTooltip">
                  Quy tắc chốt lời
                  <i class="fa fa-question-circle" aria-hidden="true"></i>
                  <ul class="tooltiptext" style="font-size:1em;">
                    <li>Với các vị thế <span class="text-warning font-weight-bold" style="font-size:1em">ngắn hạn</span>, chốt nếu đủ kỳ vọng <span class="text-warning font-weight-bold" style="font-size:1em">8-15%</span></li>
                    <li>Với các vị thế chơi <span class="text-success font-weight-bold" style="font-size:1em">theo trend</span>, vui lòng <span class="text-success font-weight-bold" style="font-size:1em">liên hệ NVCS</span> để có SL theo trend cụ thể</li>
                    <li>Khi xảy ra những phiên <span class="text-danger font-weight-bold" style="font-size:1em">hoảng loạn</span>, chốt nếu <span class="text-danger font-weight-bold" style="font-size:1em">rơi 10%</span> từ đỉnh</li>
                  </ul>
                </div>
              </div>
              <div id="ddk-noti" class="col-3 text-right">
                Thông báo <i class="start-icon fa fa-info-circle faa-tada animated"></i>
              </div>
            </div>
            <div id="bangDK" class="block-content" style="height:350px;overflow: auto;">
              <table id="ddk-table" style='margin-top:30px;width:100%'>
                <tr>
                  <th></th>
                  <th class="text-center">Thời gian</th>
                  <th class="text-center">Mã</th>
                  <th class="text-center">Giá điều kiện</th>
                  <th class="text-center">Khối lượng điều kiện</th>
                  <!--th class="text-center">ĐBKL</th-->
                  <th class="text-center">Form</th>
                </tr>
              </table>
            </div>
          </div>
          <!-- DDK End-->
        </div>
        <% } %>

      <% if(user.sl) { %>
      <div class="col-lg-6">
        <!--STOPLOSS begin-->
        <div class="block">
          <div class="row title">
            <div class="col-6 text-left">
              Cắt lỗ
            </div>
          </div>
          <div id='bangCatLo' class="block-content" style="height:350px;overflow: auto;">

          </div>
        </div>
        <!--STOPLOSS end-->
      </div>
      <% } %>

      <% if(user.personal_sltp==true) { %>
        <p style="display:none"><%- JSON.parse(personalsltp) %></p>
        <%- //include('personalsltp/personal_sltp.ejs',{user,personalsltp}); %>
      <% } %>

      <div class="col-lg-6">
        <% let clientNav = user.total_nav * 1000000000;%>
        <div class="block" id="clientNavDisplay" style="display:block">
          <div class="title">NAV Copy</div>
          <div class="number number-separator dashtext-3" id="mynav" style="font-size:2em;text-align:right;">
            <%- parseFloat(clientNav).toLocaleString('en') %>
          </div>
          <div class="progress progress-template">
            <div role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" class="progress-bar progress-bar-template dashbg-3"></div>
          </div>
          <div id="nav-change" style="text-align:right;cursor: pointer;">Thay đổi</div>
        </div>

        <div class="block" id="clientNavForm" style="display:none">
          <div class="title">
            NAV Copy
          </div>
          <form action="apphome" method="post">
            <input id="clientNavInput" type="text" name="clientnav" value="<%- parseFloat(clientNav).toLocaleString('en') %>" class="form-control number-separator" onfocus="this.value = this.value;">
            <div style="text-align:center">
              <input type="submit" name="client_nav_submit" value="Xác nhận" class="btn btn-outline-secondary" style="width:100px">
              <button  id="nav-change-cancel" type="button" class="btn btn-outline-secondary" style="width:100px">Hủy</button>
            </div>
          </form>
        </div>

        <div class="block" style="">
          <div class="title">Lệnh trong ngày</div>
          <div id="intraday" class="block-content"  id="output" style="height:200px;overflow:auto">
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="block" style="">
          <div class="title">Lịch sử lệnh</div>
          <div id="records" class="block-content" style="height:350px;overflow: auto;"></div>
        </div>

      </div>
    </div>



      <!-- DDK Noti -->
      <div id="ddk-noti-container" class="ddk-noti-container">
          <div class="ddk-noti-header">
            <div id="ddk-noti-close" class="ddk-noti-close btn btn-danger">X</div>
          </div>
          <div class="ddk-noti-body"  id="vol21DK">
          </div>
      </div>

      <!-- Image Modal -->
      <div id="imgModal" class="modal">
        <span class="close">&times;</span>
        <img id="modal-img" class="modal-content">
        <div id="caption"></div>
      </div>

      <!-- Notification -->
      <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content text-center">
          <div class="modal-header d-flex justify-content-center">
            <h3 class="heading">Lệnh mới</h3>
          </div>
          <div class="modal-body">
            <div id="modal-msg"></div>
          </div>
          <div class="modal-footer d-flex justify-content-center">
            <span id="modal-close" class="btn btn-danger">Đóng</span>
          </div>
        </div>

      </div>
      <!-- /Notification -->


    </div>
  </div>
</section>

<script>
  var portfolio = [{ticker:'Tiền mặt',amount:1000,equity:1,price:0.001}];  //ticker,amount,equity,price
  var records = [];  //time,direction,ticker,vol,pct,price,avg_cost,profit
  var trades = <%- JSON.stringify(trades) %>;
  var clientNav = <%- clientNav %>;

  function addZero(numb) {
    if(numb<10){
      return "0"+numb;
    } else {
      return ""+numb;
    }
  }

  let intraday = document.getElementById('intraday');

  function newVol(fNav, mNav, fVol){
    var Vol = Math.floor(mNav/1000000000/fNav*fVol*1000000/100)*100;
    return Vol;
  }

  function checkTime(i) {
    if (i < 10) {
      i = "0" + i;
    }
    return i;
  }

  function updateIntraday(data) {

    var m = new Date(data.order_time);
    var d = addZero(m.getDate()) +"/"+ addZero(m.getMonth()+1) +"/"+ m.getFullYear();
    var dt = addZero(m.getDate()) +"/"+ addZero(m.getMonth()+1) +"/"+ m.getFullYear()  + " " + addZero(m.getHours()) + ":" + addZero(m.getMinutes()) + ":" + addZero(m.getSeconds());

    var today = new Date();
    var date = checkTime(today.getDate())+'/'+checkTime(today.getMonth()+1)+'/'+today.getFullYear();
    if(d == date){
      // Handling Nav
      var fundnav = +data.fund_nav;
      var fundvol = +data.vol;
      var order="";
      if (data.order_direction=="buy"){
        order="Mua";
      } else if (data.order_direction=="sell") {
        order="Bán";
      }

      var prz='';
      var odrtp = data.order_type;
      if(odrtp.toUpperCase()!='LO'){
        prz=odrtp;
      } else {
        prz=data.price
      }



      var neuVol = newVol(fundnav,clientNav,fundvol).toString();
      if (neuVol>0 && order!="")
      {
        neuVol = neuVol.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        let intradayCache = intraday.innerHTML;
        intraday.innerHTML = '<p class="order-msg"><span class="text-secondary mr-2">' + dt + ': </span><strong>' + order + " " + neuVol + " " + data.ticker.toUpperCase() + " giá " + prz + '</strong></p>';
        intraday.innerHTML += intradayCache;
      }
      if (data.pct!=null){
        let intradayCache = intraday.innerHTML;
        intraday.innerHTML = '<p class="order-msg"><span class="text-secondary mr-2">' + dt + ': </span><strong>' + order + " " + data.pct + "% " + data.ticker.toUpperCase() + " giá " + prz + '</strong></p>';
        intraday.innerHTML += intradayCache;
      }

    }
  }

  for(var i=0; i<trades.length; i++){
    updateIntraday(trades[i]);
    if(trades[i].order_direction=='buy'){
      if(portfolio.length==0){
        // Portfolio is empty
        portfolio.push({ticker:trades[i].ticker.toUpperCase(),amount:trades[i].vol,equity:trades[i].vol*trades[i].price,price:trades[i].price});
        records.push({
          id:trades[i].id,
          time:trades[i].order_time,
          direction:'MUA',
          ticker:trades[i].ticker.toUpperCase(),
          vol:newVol(trades[i].fund_nav,clientNav,trades[i].vol),
          pct:0,
          price:trades[i].price,
          avg_cost:trades[i].price,
          profit:0
        });
        portfolio[0].equity-=trades[i].vol*trades[i].price;
        portfolio[0].amount=portfolio[0].equity/portfolio[0].price;
      } else {
        // Portfolio has stocks in it
        let tickerFound=0;
        for(var j=0; j<portfolio.length; j++){
          if(trades[i].ticker.toUpperCase()==portfolio[j].ticker){
            tickerFound++;
            portfolio[j].amount+=trades[i].vol;
            portfolio[j].equity+=trades[i].vol*trades[i].price;
            portfolio[j].price=trades[i].price;
            records.push({
              id:trades[i].id,
              time:trades[i].order_time,
              direction:'MUA',
              ticker:trades[i].ticker.toUpperCase(),
              vol:newVol(trades[i].fund_nav,clientNav,trades[i].vol),
              pct:0,
              price:trades[i].price,
              avg_cost:portfolio[j].equity/portfolio[j].amount,
              profit:0
            });
            portfolio[0].equity-=trades[i].vol*trades[i].price;
            portfolio[0].amount=portfolio[0].equity/portfolio[0].price;
            break;
          }
        }
        if(tickerFound==0){
          // Add ticker to portfolio
          portfolio.push({ticker:trades[i].ticker.toUpperCase(),amount:trades[i].vol,equity:trades[i].vol*trades[i].price,price:trades[i].price});
          records.push({
            id:trades[i].id,
            time:trades[i].order_time,
            direction:'MUA',
            ticker:trades[i].ticker.toUpperCase(),
            vol:newVol(trades[i].fund_nav,clientNav,trades[i].vol),
            pct:0,
            price:trades[i].price,
            avg_cost:trades[i].price,
            profit:0
          });
          portfolio[0].equity-=trades[i].vol*trades[i].price;
          portfolio[0].amount=portfolio[0].equity/portfolio[0].price;
        }
      }
    } else {
      // Sell order
      if(portfolio.length>0){
        if(trades[i].pct==null){
          for(var j=0; j<portfolio.length; j++){
            if(trades[i].ticker.toUpperCase()==portfolio[j].ticker){
              if(portfolio[j].amount<trades[i].vol){
                let avg_cost = portfolio[j].equity/portfolio[j].amount;
                records.push({
                  id:trades[i].id,
                  time:trades[i].order_time,
                  direction:'BÁN',
                  ticker:trades[i].ticker.toUpperCase(),
                  vol:newVol(trades[i].fund_nav,clientNav,trades[i].vol),
                  pct:0,
                  price:trades[i].price,
                  avg_cost:avg_cost,
                  profit:((trades[i].price-avg_cost)/avg_cost)*100
                });
                portfolio[j].amount=0;
                portfolio[j].equity=0;
                portfolio[j].price=trades[i].price;
                portfolio[0].equity+=trades[i].vol*trades[i].price;
                portfolio[0].amount=portfolio[0].equity/portfolio[0].price;
              } else {
                let avg_cost = portfolio[j].equity/portfolio[j].amount;
                records.push({
                  id:trades[i].id,
                  time:trades[i].order_time,
                  direction:'BÁN',
                  ticker:trades[i].ticker.toUpperCase(),
                  vol:newVol(trades[i].fund_nav,clientNav,trades[i].vol),
                  pct:0,
                  price:trades[i].price,
                  avg_cost:avg_cost,
                  profit:((trades[i].price-avg_cost)/avg_cost)*100
                });
                portfolio[j].amount-=trades[i].vol;
                portfolio[j].equity-=trades[i].vol*avg_cost;
                portfolio[j].price=trades[i].price;
                portfolio[0].equity+=trades[i].vol*trades[i].price;
                portfolio[0].amount=portfolio[0].equity/portfolio[0].price;
              }
            }
          }
        } else {
          for(var j=0; j<portfolio.length; j++){
            if(trades[i].ticker.toUpperCase()==portfolio[j].ticker){
              let sellAmount = trades[i].pct*portfolio[j].amount/100;
              if(portfolio[j].amount<sellAmount){
                let avg_cost = portfolio[j].equity/portfolio[j].amount;
                records.push({
                  id:trades[i].id,
                  time:trades[i].order_time,
                  direction:'BÁN',
                  ticker:trades[i].ticker.toUpperCase(),
                  vol:newVol(trades[i].fund_nav,clientNav,sellAmount),
                  pct:trades[i].pct,
                  price:trades[i].price,
                  avg_cost:avg_cost,
                  profit:((trades[i].price-avg_cost)/avg_cost)*100
                });
                portfolio[j].amount=0;
                portfolio[j].equity=0;
                portfolio[j].price=trades[i].price;
                portfolio[0].equity+=sellAmount*trades[i].price;
                portfolio[0].amount=portfolio[0].equity/portfolio[0].price;
              } else {
                let avg_cost = portfolio[j].equity/portfolio[j].amount;
                records.push({
                  id:trades[i].id,
                  time:trades[i].order_time,
                  direction:'BÁN',
                  ticker:trades[i].ticker.toUpperCase(),
                  vol:newVol(trades[i].fund_nav,clientNav,sellAmount),
                  pct:trades[i].pct,
                  price:trades[i].price,
                  avg_cost:avg_cost,
                  profit:((trades[i].price-avg_cost)/avg_cost)*100
                });
                portfolio[j].amount-=sellAmount;
                portfolio[j].equity-=sellAmount*avg_cost;
                portfolio[j].price=trades[i].price;
                portfolio[0].equity+=sellAmount*trades[i].price;
                portfolio[0].amount=portfolio[0].equity/portfolio[0].price;
              }
            }
          }
        }
      }
    }
    //console.log(portfolio);
  }


  //console.log(records);


  let recordTableContent = '<table id="recordTable" style="margin-top:30px;width:100%;text-align:center"><tr><th>id</th><th>Thời gian</th><th>Lệnh</th><th>Mã</th><th>Khối lượng</th><th>Tỷ trọng bán</th><th>Giá</th><th>Giá vốn TB</th><th>Lãi/lỗ</th></tr>';
  for(var i=records.length-1; i>=0; i--){
    var pctDisplay='',
        profitDisplay='',
        profitStyle='';
    if(records[i].pct>0) pctDisplay=records[i].pct.toFixed(2)+'%';
    if(records[i].profit>0) {
      profitDisplay=records[i].profit.toFixed(2)+'%';
      profitStyle='text-success';
    }
    if(records[i].profit<0) {
      profitDisplay=records[i].profit.toFixed(2)+'%';
      profitStyle='text-danger';
    }
    var m = new Date(records[i].time);
    var dt = addZero(m.getDate()) +"/"+ addZero(m.getMonth()+1) +"/"+ m.getFullYear()  + " " + addZero(m.getHours()) + ":" + addZero(m.getMinutes()) + ":" + addZero(m.getSeconds());
    recordTableContent+='<tr><td>'+records[i].id+'</td><td>'+dt+'</td><td>'+records[i].direction+'</td><td>'+records[i].ticker+'</td><td>'+(records[i].vol).toLocaleString('en')+'</td><td>'+pctDisplay+'</td><td>'+records[i].price+'</td><td>'+records[i].avg_cost.toFixed(2)+'</td><td class="'+profitStyle+'">'+profitDisplay+'</td></tr>';
  }
  recordTableContent+='</table>';

  let  recordTable = document.getElementById('records');
  if(recordTable!=null){
    recordTable.innerHTML = recordTableContent;
  }

  let totalCap=0;
  let portfolioChartData=[];
  for(var i=0;i<portfolio.length;i++){
    totalCap+=portfolio[i].amount * portfolio[i].price;
  }
  for(var i=0;i<portfolio.length;i++){
    if(portfolio[i].amount>0){
      portfolioChartData.push({y:portfolio[i].equity/totalCap*100,label:portfolio[i].ticker});
    }
  }


</script>
